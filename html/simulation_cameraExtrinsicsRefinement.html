
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>simulation_cameraExtrinsicsRefinement</title><meta name="generator" content="MATLAB 8.5"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-06-16"><meta name="DC.source" content="simulation_cameraExtrinsicsRefinement.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">(2) Create a T_wc matrix</a></li><li><a href="#3">(4)run PB function</a></li><li><a href="#4">Run World Known Poses Based Optimization (with test data)</a></li><li><a href="#5">Results</a></li></ul></div><pre class="codeinput">clear
clc

path = <span class="string">'/home/cat/Documents/CMU_Herb/camera_ext_calibration/'</span>;
path = <span class="string">'~/cat_workspace/src/ExtrinsicsCalibration/matlab_code/'</span>;
addpath([path, <span class="string">'ADAcode'</span>])

<span class="comment">% (1) Create world data from a table randomly</span>

n = 100;
tb_height = 0.5;

min_x = 0.5; max_x = 1;
min_y = -0.3; max_y = 0.3;
x = min_x + (max_x-min_x).*rand(n,1);
y = min_y + (max_y-min_y).*rand(n,1);
z = ones(n,1).* tb_height;
tag_xyz = [x y z ones(n, 1)];

<span class="keyword">for</span> i=1:n
    tag_euler = [0 0 0.0001];
    tag_rotation = rotationAroundZ(tag_euler(3))* rotationAroundY(tag_euler(2))* rotationAroundX(tag_euler(1));
    T_w2tag(:, :, i) = [tag_rotation tag_xyz(i, 1:3)'; 0 0 0 1];
<span class="keyword">end</span>

tag_size = 0.06;
ts = tag_size/2;
<span class="keyword">for</span> i=1:n
    t = T_w2tag(:, :, i);
    c1 = t; c1(1,4) = t(1,4)+ts; c1(2,4) = t(2,4)+ts;
    c2 = t; c2(1,4) = t(1,4)-ts; c2(2,4) = t(2,4)+ts;
    c3 = t; c3(1,4) = t(1,4)-ts; c3(2,4) = t(2,4)-ts;
    c4 = t; c4(1,4) = t(1,4)+ts; c4(2,4) = t(2,4)-ts;

    T_w2tag_c1(:, :, i) = c1;
    T_w2tag_c2(:, :, i) = c2;
    T_w2tag_c3(:, :, i) = c3;
    T_w2tag_c4(:, :, i) = c4;
<span class="keyword">end</span>
</pre><h2>(2) Create a T_wc matrix<a name="2"></a></h2><pre class="codeinput">T_w2c_init = [0.9754 0.2206 0 -0.0470; <span class="keyword">...</span>
         -0.2206 0.9754 0 0.05; <span class="keyword">...</span>
         0 0 1 -0.09; <span class="keyword">...</span>
         0 0 0 1];

<span class="comment">% using T_w2c (perfect matrix)</span>
tagposes = T_w2tag;
<span class="keyword">for</span> n =1:size(T_w2tag,3)
   <span class="comment">% passing T_c_tag</span>
   T_c_tag(:, :, n) = inv(T_w2c_init) * tagposes(:, :, n);
   T_c_c1(:, :, n) = inv(T_w2c_init) * T_w2tag_c1(:, :, n);
   T_c_c2(:, :, n) = inv(T_w2c_init) * T_w2tag_c2(:, :, n);
   T_c_c3(:, :, n) = inv(T_w2c_init) * T_w2tag_c3(:, :, n);
   T_c_c4(:, :, n) = inv(T_w2c_init) * T_w2tag_c4(:, :, n);
<span class="keyword">end</span>

A = [529.2945         0  466.9604         0; <span class="keyword">...</span>
            0  531.2835  273.2594         0; <span class="keyword">...</span>
            0         0    1.0000         0; <span class="keyword">...</span>
            0         0         0    1.0000];

c1 = []; c2 = []; c3 = []; c4 = [];
<span class="keyword">for</span> n =1:size(T_w2tag,3)
   tc_1 = T_c_c1(:, :, n) ;
   corner1 = A * tc_1(1:4, 4);
   c1(n, :) = [corner1(1)/corner1(3) corner1(2)/corner1(3) 1];

   tc_2 = T_c_c2(:, :, n) ;
   corner2 = A * tc_2(1:4, 4);
   c2(n, :) = [corner2(1)/corner2(3) corner2(2)/corner2(3) 1];

   tc_3 = T_c_c3(:, :, n) ;
   corner3 = A * tc_3(1:4, 4);
   c3(n, :) = [corner3(1)/corner3(3) corner3(2)/corner3(3) 1];

   tc_4 = T_c_c4(:, :, n) ;
   corner4 = A * tc_4(1:4, 4);
   c4(n, :) = [corner4(1)/corner4(3) corner4(2)/corner4(3) 1];
<span class="keyword">end</span>


<span class="comment">% (3) Add Gaussian noise (statistically independent and addictive noise) to</span>
<span class="comment">% data</span>

ratio = 0.3;
a = rodrigues(T_w2c_init(1:3, 1:3));
N = randn(size(a));
N = N*ratio;
a = a + N;
R = rodrigues(a);
t = T_w2c_init(1:3, 4);N = randn(size(t));N = N*ratio;
t = t + N;
T_w2c_init_n = [R t; 0 0 0 1];

counter = 0;
<span class="keyword">for</span> i=1:size(T_c_tag,3)

    t_c = T_c_tag(:, :, i)
    t_w = T_w2c_init_n * t_c

    zhat_tag = t_w(1:3, 3);
    z_tag =  t_w(3, 4);
    counter = counter + 1;
    norm_z(counter) = norm(z_tag - 0.5);

    CosTheta = dot(zhat_tag, [0 0 1]')/(norm(zhat_tag)*norm([0 0 1]'));
    theta_error(counter) = acos(CosTheta);

<span class="keyword">end</span>

wld_points_train = T_w2tag(:, :, 1:n/2);
wld_points_test = T_w2tag(:, :, n/2+1:end);
cam_points_train = T_c_tag(:, :, 1:n/2);
cam_points_test = T_c_tag(:, :, n/2+1:end);
corners_train.c1 = c1(1:n/2, :);
corners_train.c2 = c2(1:n/2, :);
corners_train.c3 = c3(1:n/2, :);
corners_train.c4 = c4(1:n/2, :);
corners_test.c1 = c1(n/2+1:end, :);
corners_test.c2 = c2(n/2+1:end, :);
corners_test.c3 = c3(n/2+1:end, :);
corners_test.c4 = c4(n/2+1:end, :);
</pre><pre class="codeoutput">
t_c =

    0.9753   -0.2207         0    0.9312
    0.2207    0.9753         0    0.1118
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5398
    0.1966    0.9516    0.2362    0.3894
    0.2611   -0.2830    0.9229    0.6199
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6634
    0.2207    0.9753         0    0.0124
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2767
    0.1966    0.9516    0.2362    0.2977
    0.2611   -0.2830    0.9229    0.5566
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7262
    0.2207    0.9753         0    0.1488
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3487
    0.1966    0.9516    0.2362    0.4291
    0.2611   -0.2830    0.9229    0.5467
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7815
    0.2207    0.9753         0    0.2747
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4128
    0.1966    0.9516    0.2362    0.5504
    0.2611   -0.2830    0.9229    0.5368
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6662
    0.2207    0.9753         0    0.0529
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2831
    0.1966    0.9516    0.2362    0.3370
    0.2611   -0.2830    0.9229    0.5487
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8669
    0.2207    0.9753         0    0.1014
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4779
    0.1966    0.9516    0.2362    0.3804
    0.2611   -0.2830    0.9229    0.6018
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8304
    0.2207    0.9753         0   -0.0942
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4253
    0.1966    0.9516    0.2362    0.1911
    0.2611   -0.2830    0.9229    0.6329
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6815
    0.2207    0.9753         0   -0.1897
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2753
    0.1966    0.9516    0.2362    0.1011
    0.2611   -0.2830    0.9229    0.6065
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.9536
    0.2207    0.9753         0    0.0354
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5540
    0.1966    0.9516    0.2362    0.3147
    0.2611   -0.2830    0.9229    0.6437
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6177
    0.2207    0.9753         0   -0.0238
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2301
    0.1966    0.9516    0.2362    0.2634
    0.2611   -0.2830    0.9229    0.5501
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6676
    0.2207    0.9753         0    0.1943
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2974
    0.1966    0.9516    0.2362    0.4743
    0.2611   -0.2830    0.9229    0.5183
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.5998
    0.2207    0.9753         0    0.3655
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2488
    0.1966    0.9516    0.2362    0.6419
    0.2611   -0.2830    0.9229    0.4594
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7458
    0.2207    0.9753         0    0.3854
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3890
    0.1966    0.9516    0.2362    0.6586
    0.2611   -0.2830    0.9229    0.5013
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.5947
    0.2207    0.9753         0    0.0573
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2157
    0.1966    0.9516    0.2362    0.3426
    0.2611   -0.2830    0.9229    0.5250
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7765
    0.2207    0.9753         0   -0.0353
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3796
    0.1966    0.9516    0.2362    0.2493
    0.2611   -0.2830    0.9229    0.6029
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.5607
    0.2207    0.9753         0    0.2379
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2001
    0.1966    0.9516    0.2362    0.5187
    0.2611   -0.2830    0.9229    0.4748
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.5650
    0.2207    0.9753         0    0.2360
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2039
    0.1966    0.9516    0.2362    0.5168
    0.2611   -0.2830    0.9229    0.4766
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8952
    0.2207    0.9753         0    0.2992
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5228
    0.1966    0.9516    0.2362    0.5722
    0.2611   -0.2830    0.9229    0.5675
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6545
    0.2207    0.9753         0    0.2467
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2897
    0.1966    0.9516    0.2362    0.5255
    0.2611   -0.2830    0.9229    0.5026
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8910
    0.2207    0.9753         0   -0.0922
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4829
    0.1966    0.9516    0.2362    0.1920
    0.2611   -0.2830    0.9229    0.6517
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.9908
    0.2207    0.9753         0    0.2845
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.6121
    0.1966    0.9516    0.2362    0.5561
    0.2611   -0.2830    0.9229    0.6011
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7603
    0.2207    0.9753         0    0.0981
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3764
    0.1966    0.9516    0.2362    0.3792
    0.2611   -0.2830    0.9229    0.5687
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.9214
    0.2207    0.9753         0   -0.0199
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5184
    0.1966    0.9516    0.2362    0.2616
    0.2611   -0.2830    0.9229    0.6455
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.9674
    0.2207    0.9753         0   -0.0794
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5565
    0.1966    0.9516    0.2362    0.2029
    0.2611   -0.2830    0.9229    0.6731
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7127
    0.2207    0.9753         0    0.3090
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3507
    0.1966    0.9516    0.2362    0.5850
    0.2611   -0.2830    0.9229    0.5075
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.9072
    0.2207    0.9753         0   -0.0460
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5025
    0.1966    0.9516    0.2362    0.2365
    0.2611   -0.2830    0.9229    0.6467
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6426
    0.2207    0.9753         0   -0.1129
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2455
    0.1966    0.9516    0.2362    0.1764
    0.2611   -0.2830    0.9229    0.5774
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.9779
    0.2207    0.9753         0    0.2720
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5988
    0.1966    0.9516    0.2362    0.5442
    0.2611   -0.2830    0.9229    0.5997
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.5838
    0.2207    0.9753         0    0.3234
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2297
    0.1966    0.9516    0.2362    0.6013
    0.2611   -0.2830    0.9229    0.4635
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6722
    0.2207    0.9753         0    0.1109
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2940
    0.1966    0.9516    0.2362    0.3933
    0.2611   -0.2830    0.9229    0.5379
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.9068
    0.2207    0.9753         0    0.2785
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5319
    0.1966    0.9516    0.2362    0.5518
    0.2611   -0.2830    0.9229    0.5757
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8282
    0.2207    0.9753         0   -0.0770
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4247
    0.1966    0.9516    0.2362    0.2078
    0.2611   -0.2830    0.9229    0.6284
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8595
    0.2207    0.9753         0    0.4221
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5003
    0.1966    0.9516    0.2362    0.6922
    0.2611   -0.2830    0.9229    0.5294
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7322
    0.2207    0.9753         0    0.1395
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3536
    0.1966    0.9516    0.2362    0.4199
    0.2611   -0.2830    0.9229    0.5507
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6539
    0.2207    0.9753         0    0.2072
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2855
    0.1966    0.9516    0.2362    0.4871
    0.2611   -0.2830    0.9229    0.5111
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6240
    0.2207    0.9753         0   -0.1952
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2203
    0.1966    0.9516    0.2362    0.0968
    0.2611   -0.2830    0.9229    0.5895
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8320
    0.2207    0.9753         0    0.3271
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4654
    0.1966    0.9516    0.2362    0.6004
    0.2611   -0.2830    0.9229    0.5414
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7211
    0.2207    0.9753         0    0.2648
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3546
    0.1966    0.9516    0.2362    0.5419
    0.2611   -0.2830    0.9229    0.5198
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8151
    0.2207    0.9753         0   -0.1005
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4102
    0.1966    0.9516    0.2362    0.1852
    0.2611   -0.2830    0.9229    0.6294
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8386
    0.2207    0.9753         0    0.1538
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4558
    0.1966    0.9516    0.2362    0.4319
    0.2611   -0.2830    0.9229    0.5813
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.5966
    0.2207    0.9753         0   -0.0235
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2100
    0.1966    0.9516    0.2362    0.2641
    0.2611   -0.2830    0.9229    0.5433
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6924
    0.2207    0.9753         0    0.1339
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3153
    0.1966    0.9516    0.2362    0.4152
    0.2611   -0.2830    0.9229    0.5393
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.9347
    0.2207    0.9753         0    0.0979
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5418
    0.1966    0.9516    0.2362    0.3759
    0.2611   -0.2830    0.9229    0.6240
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8954
    0.2207    0.9753         0    0.0990
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5046
    0.1966    0.9516    0.2362    0.3776
    0.2611   -0.2830    0.9229    0.6113
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6479
    0.2207    0.9753         0   -0.1011
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2516
    0.1966    0.9516    0.2362    0.1877
    0.2611   -0.2830    0.9229    0.5765
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6404
    0.2207    0.9753         0   -0.0569
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2485
    0.1966    0.9516    0.2362    0.2308
    0.2611   -0.2830    0.9229    0.5645
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6530
    0.2207    0.9753         0   -0.1985
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2475
    0.1966    0.9516    0.2362    0.0930
    0.2611   -0.2830    0.9229    0.5994
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.4923
    0.2207    0.9753         0    0.3207
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.1427
    0.1966    0.9516    0.2362    0.6004
    0.2611   -0.2830    0.9229    0.4350
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7305
    0.2207    0.9753         0    0.2085
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3583
    0.1966    0.9516    0.2362    0.4870
    0.2611   -0.2830    0.9229    0.5351
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8070
    0.2207    0.9753         0    0.3974
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4482
    0.1966    0.9516    0.2362    0.6691
    0.2611   -0.2830    0.9229    0.5181
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.9416
    0.2207    0.9753         0   -0.0453
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5352
    0.1966    0.9516    0.2362    0.2366
    0.2611   -0.2830    0.9229    0.6575
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7479
    0.2207    0.9753         0    0.3769
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3902
    0.1966    0.9516    0.2362    0.6503
    0.2611   -0.2830    0.9229    0.5038
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.5586
    0.2207    0.9753         0    0.2563
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.1997
    0.1966    0.9516    0.2362    0.5366
    0.2611   -0.2830    0.9229    0.4701
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8424
    0.2207    0.9753         0    0.1869
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4624
    0.1966    0.9516    0.2362    0.4640
    0.2611   -0.2830    0.9229    0.5753
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6142
    0.2207    0.9753         0    0.0508
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2335
    0.1966    0.9516    0.2362    0.3359
    0.2611   -0.2830    0.9229    0.5326
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6421
    0.2207    0.9753         0   -0.0551
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2503
    0.1966    0.9516    0.2362    0.2325
    0.2611   -0.2830    0.9229    0.5646
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.5593
    0.2207    0.9753         0    0.2302
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.1980
    0.1966    0.9516    0.2362    0.5112
    0.2611   -0.2830    0.9229    0.4760
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6497
    0.2207    0.9753         0   -0.0712
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2560
    0.1966    0.9516    0.2362    0.2167
    0.2611   -0.2830    0.9229    0.5706
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6843
    0.2207    0.9753         0   -0.1646
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2802
    0.1966    0.9516    0.2362    0.1254
    0.2611   -0.2830    0.9229    0.6019
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6049
    0.2207    0.9753         0    0.2500
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2430
    0.1966    0.9516    0.2362    0.5296
    0.2611   -0.2830    0.9229    0.4862
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6767
    0.2207    0.9753         0    0.2071
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3072
    0.1966    0.9516    0.2362    0.4866
    0.2611   -0.2830    0.9229    0.5183
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6704
    0.2207    0.9753         0    0.2327
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3035
    0.1966    0.9516    0.2362    0.5117
    0.2611   -0.2830    0.9229    0.5107
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6318
    0.2207    0.9753         0    0.1790
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2621
    0.1966    0.9516    0.2362    0.4602
    0.2611   -0.2830    0.9229    0.5102
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6777
    0.2207    0.9753         0    0.0522
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2939
    0.1966    0.9516    0.2362    0.3361
    0.2611   -0.2830    0.9229    0.5525
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.9944
    0.2207    0.9753         0    0.1064
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5992
    0.1966    0.9516    0.2362    0.3830
    0.2611   -0.2830    0.9229    0.6411
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8456
    0.2207    0.9753         0    0.3345
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4790
    0.1966    0.9516    0.2362    0.6073
    0.2611   -0.2830    0.9229    0.5441
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8397
    0.2207    0.9753         0    0.0263
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4452
    0.1966    0.9516    0.2362    0.3081
    0.2611   -0.2830    0.9229    0.6095
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.5928
    0.2207    0.9753         0    0.2763
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2340
    0.1966    0.9516    0.2362    0.5554
    0.2611   -0.2830    0.9229    0.4766
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6097
    0.2207    0.9753         0    0.2644
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2489
    0.1966    0.9516    0.2362    0.5436
    0.2611   -0.2830    0.9229    0.4846
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.5356
    0.2207    0.9753         0    0.2866
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.1807
    0.1966    0.9516    0.2362    0.5664
    0.2611   -0.2830    0.9229    0.4562
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.9894
    0.2207    0.9753         0    0.1760
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.6008
    0.1966    0.9516    0.2362    0.4507
    0.2611   -0.2830    0.9229    0.6243
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8712
    0.2207    0.9753         0    0.2292
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4937
    0.1966    0.9516    0.2362    0.5046
    0.2611   -0.2830    0.9229    0.5752
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7569
    0.2207    0.9753         0    0.3973
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4007
    0.1966    0.9516    0.2362    0.6699
    0.2611   -0.2830    0.9229    0.5022
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7048
    0.2207    0.9753         0    0.0737
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3216
    0.1966    0.9516    0.2362    0.3565
    0.2611   -0.2830    0.9229    0.5564
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6838
    0.2207    0.9753         0   -0.1673
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2796
    0.1966    0.9516    0.2362    0.1228
    0.2611   -0.2830    0.9229    0.6023
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7996
    0.2207    0.9753         0    0.3552
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4373
    0.1966    0.9516    0.2362    0.6283
    0.2611   -0.2830    0.9229    0.5250
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    1.0090
    0.2207    0.9753         0    0.2576
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.6269
    0.1966    0.9516    0.2362    0.5297
    0.2611   -0.2830    0.9229    0.6127
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6468
    0.2207    0.9753         0    0.0059
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2604
    0.1966    0.9516    0.2362    0.2917
    0.2611   -0.2830    0.9229    0.5528
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6045
    0.2207    0.9753         0    0.3912
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2556
    0.1966    0.9516    0.2362    0.6668
    0.2611   -0.2830    0.9229    0.4552
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7745
    0.2207    0.9753         0   -0.0458
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3767
    0.1966    0.9516    0.2362    0.2392
    0.2611   -0.2830    0.9229    0.6046
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.5604
    0.2207    0.9753         0    0.1693
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.1935
    0.1966    0.9516    0.2362    0.4520
    0.2611   -0.2830    0.9229    0.4897
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8643
    0.2207    0.9753         0    0.2088
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4852
    0.1966    0.9516    0.2362    0.4849
    0.2611   -0.2830    0.9229    0.5775
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7557
    0.2207    0.9753         0    0.0503
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3677
    0.1966    0.9516    0.2362    0.3329
    0.2611   -0.2830    0.9229    0.5776
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    1.0712
    0.2207    0.9753         0   -0.0291
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.6595
    0.1966    0.9516    0.2362    0.2500
    0.2611   -0.2830    0.9229    0.6950
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8035
    0.2207    0.9753         0   -0.1616
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3936
    0.1966    0.9516    0.2362    0.1261
    0.2611   -0.2830    0.9229    0.6391
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8577
    0.2207    0.9753         0    0.0942
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4684
    0.1966    0.9516    0.2362    0.3736
    0.2611   -0.2830    0.9229    0.6004
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6616
    0.2207    0.9753         0   -0.0959
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2651
    0.1966    0.9516    0.2362    0.1925
    0.2611   -0.2830    0.9229    0.5797
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7006
    0.2207    0.9753         0    0.2461
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3334
    0.1966    0.9516    0.2362    0.5241
    0.2611   -0.2830    0.9229    0.5174
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6403
    0.2207    0.9753         0    0.0138
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2549
    0.1966    0.9516    0.2362    0.2995
    0.2611   -0.2830    0.9229    0.5490
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8690
    0.2207    0.9753         0    0.3554
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5032
    0.1966    0.9516    0.2362    0.6272
    0.2611   -0.2830    0.9229    0.5470
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.9383
    0.2207    0.9753         0    0.3050
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5643
    0.1966    0.9516    0.2362    0.5770
    0.2611   -0.2830    0.9229    0.5799
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7062
    0.2207    0.9753         0    0.1521
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3301
    0.1966    0.9516    0.2362    0.4327
    0.2611   -0.2830    0.9229    0.5397
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.9216
    0.2207    0.9753         0   -0.0416
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5166
    0.1966    0.9516    0.2362    0.2405
    0.2611   -0.2830    0.9229    0.6503
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.6274
    0.2207    0.9753         0    0.3720
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.2756
    0.1966    0.9516    0.2362    0.6478
    0.2611   -0.2830    0.9229    0.4667
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8344
    0.2207    0.9753         0   -0.0069
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4370
    0.1966    0.9516    0.2362    0.2758
    0.2611   -0.2830    0.9229    0.6151
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8943
    0.2207    0.9753         0    0.4122
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.5323
    0.1966    0.9516    0.2362    0.6819
    0.2611   -0.2830    0.9229    0.5426
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.8725
    0.2207    0.9753         0   -0.0239
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.4716
    0.1966    0.9516    0.2362    0.2587
    0.2611   -0.2830    0.9229    0.6309
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7248
    0.2207    0.9753         0    0.0349
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3370
    0.1966    0.9516    0.2362    0.3185
    0.2611   -0.2830    0.9229    0.5712
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7451
    0.2207    0.9753         0   -0.1365
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3405
    0.1966    0.9516    0.2362    0.1516
    0.2611   -0.2830    0.9229    0.6150
         0         0         0    1.0000


t_c =

    0.9753   -0.2207         0    0.7467
    0.2207    0.9753         0    0.2038
         0         0    1.0000    0.5900
         0         0         0    1.0000


t_w =

    0.9450   -0.1197   -0.3041    0.3733
    0.1966    0.9516    0.2362    0.4822
    0.2611   -0.2830    0.9229    0.5413
         0         0         0    1.0000

</pre><h2>(4)run PB function<a name="3"></a></h2><pre class="codeinput"><span class="comment">%  find x</span>
w=rodrigues(T_w2c_init_n(1:3, 1:3))
wx=w(1);
wy=w(2);
wz=w(3);

x0 =[wx, wy, wz, T_w2c_init_n(1,4), T_w2c_init_n(2,4), T_w2c_init_n(3,4)]

<span class="comment">% optimization using fmincon</span>
options = optimoptions(<span class="string">'fmincon'</span>, <span class="string">'Display'</span>,<span class="string">'iter'</span>, <span class="string">'Algorithm'</span>, <span class="string">'interior-point'</span>);
[x, fval, exittag] = fmincon(@simulation_minimizeExtrinsics,x0,[],[],[],[],[],[],[], options, cam_points_train, corners_train, x0);

<span class="comment">% get refined extrinsics</span>
[R_est, t_est] = xToRt(x(1:6));

T_w2c_PB = [R_est, t_est ; 0 0 0 1];
</pre><pre class="codeoutput">
w =

   -0.2334
   -0.3191
   -0.0565


x0 =

   -0.2334   -0.3191   -0.0565   -0.1740    0.1585   -0.1956

                                            First-order      Norm of
 Iter F-count            f(x)  Feasibility   optimality         step
    0       7    2.118379e+04    0.000e+00    4.433e+04
    1      21    1.366122e+04    0.000e+00    6.960e+04    3.062e-01
    2      31    8.163015e+03    0.000e+00    4.022e+04    1.531e-01
    3      42    8.120825e+03    0.000e+00    4.410e+04    3.062e-01
    4      54    6.836138e+03    0.000e+00    5.454e+04    1.531e-01
    5      63    5.195842e+03    0.000e+00    7.087e+04    1.531e-01
    6      71    4.794862e+03    0.000e+00    6.670e+04    2.499e+01
    7      79    3.219829e+03    0.000e+00    6.668e+04    3.427e+00
    8      86    1.161726e+03    0.000e+00    7.164e+04    1.367e+01
    9      95    7.762025e+02    0.000e+00    5.836e+04    1.044e+01
   10     104    2.237305e+02    0.000e+00    5.795e+04    9.190e-01
   11     121    2.133331e+02    0.000e+00    6.386e+04    1.084e-03
   12     129    2.132743e+02    0.000e+00    6.409e+04    1.084e-03
   13     141    2.074228e+02    0.000e+00    6.672e+04    1.084e-03
   14     149    2.073529e+02    0.000e+00    6.672e+04    1.084e-03
   15     162    1.835517e+02    0.000e+00    5.535e+04    5.420e-04
   16     170    1.833739e+02    0.000e+00    5.470e+04    3.794e-03
   17     182    1.825162e+02    0.000e+00    4.063e+04    1.445e-04
   18     190    1.825090e+02    0.000e+00    4.063e+04    1.445e-04
   19     201    1.807669e+02    0.000e+00    2.499e+04    6.825e-05
   20     209    1.807429e+02    0.000e+00    2.499e+04    4.777e-04
   21     220    1.804978e+02    0.000e+00    2.598e+04    4.129e-05
   22     228    1.804501e+02    0.000e+00    2.596e+04    9.555e-04
   23     239    1.802561e+02    0.000e+00    9.416e+03    1.059e-05
   24     247    1.801608e+02    0.000e+00    9.358e+03    1.911e-03
   25     258    1.801399e+02    0.000e+00    1.801e+03    3.586e-06
   26     266    1.799501e+02    0.000e+00    1.811e+03    3.822e-03
   27     277    1.795673e+02    0.000e+00    8.478e+02    7.644e-03
   28     285    1.769042e+02    0.000e+00    7.972e+02    5.351e-02
   29     296    1.715537e+02    0.000e+00    1.226e+03    1.070e-01
   30     304    1.342529e+02    0.000e+00    1.952e+03    7.491e-01

                                            First-order      Norm of
 Iter F-count            f(x)  Feasibility   optimality         step
   31     315    5.939429e+01    0.000e+00    1.506e+04    1.498e+00
   32     326    5.937307e+01    0.000e+00    1.146e+04    1.607e-06
   33     337    5.934238e+01    0.000e+00    1.323e+03    4.830e-06
   34     351    1.002358e+01    0.000e+00    3.091e+03    1.311e+00
   35     360    1.987182e+00    0.000e+00    1.400e+03    1.881e-01
   36     376    1.951337e+00    0.000e+00    8.442e+02    2.561e-03
   37     383    1.928619e+00    0.000e+00    3.144e+03    1.708e-01
   38     390    1.915966e+00    0.000e+00    2.751e+03    2.848e-01
   39     398    1.911976e+00    0.000e+00    1.994e+03    4.277e-02
   40     407    1.905836e+00    0.000e+00    7.023e+02    1.337e-01
   41     415    1.904901e+00    0.000e+00    5.712e+02    7.693e-04
   42     422    1.904614e+00    0.000e+00    1.452e+02    2.373e-02
   43     429    1.904321e+00    0.000e+00    8.700e+01    9.152e-04
   44     436    1.904293e+00    0.000e+00    3.106e+01    6.962e-04
   45     444    1.904292e+00    0.000e+00    2.476e+01    5.762e-04
   46     451    1.904291e+00    0.000e+00    1.778e+01    5.796e-04
   47     461    1.904291e+00    0.000e+00    1.458e+01    2.737e-03
   48     468    1.904290e+00    0.000e+00    4.000e+00    2.277e-04
   49     476    1.904289e+00    0.000e+00    1.080e+02    4.085e-03
   50     483    1.904287e+00    0.000e+00    3.749e+01    2.397e-03
   51     491    1.904287e+00    0.000e+00    2.513e+01    3.619e-04
   52     499    1.904286e+00    0.000e+00    1.082e+01    1.446e-04
   53     508    1.904286e+00    0.000e+00    7.975e+00    1.754e-05
   54     515    1.904286e+00    0.000e+00    6.478e+00    4.114e-04
   55     523    1.904286e+00    0.000e+00    9.607e+01    3.581e-03
   56     530    1.904285e+00    0.000e+00    2.321e+01    1.953e-03
   57     541    1.904285e+00    0.000e+00    1.414e+01    2.486e-08
   58     552    1.904284e+00    0.000e+00    1.888e+01    2.160e-07
   59     563    1.904284e+00    0.000e+00    5.723e+00    6.119e-08
   60     574    1.904284e+00    0.000e+00    1.625e+00    4.233e-08

                                            First-order      Norm of
 Iter F-count            f(x)  Feasibility   optimality         step
   61     590    1.904284e+00    0.000e+00    9.135e-01    4.538e-10
   62     600    1.904284e+00    0.000e+00    9.140e-01    7.941e-10
   63     615    1.904284e+00    0.000e+00    8.829e-01    9.927e-11

Local minimum possible. Constraints satisfied.

fmincon stopped because the size of the current step is less than
the default value of the step size tolerance and constraints are 
satisfied to within the default value of the constraint tolerance.



</pre><h2>Run World Known Poses Based Optimization (with test data)<a name="4"></a></h2><pre class="codeinput">counter = 0;
<span class="keyword">for</span> i=n/2+1:size(T_c_tag,3)
    counter = counter + 1;
    cam_pose(:, counter) = [T_c_tag(:, 4, i)];
    wld_pose(:, counter) = [T_w2tag(:, 4, i)];
<span class="keyword">end</span>

w=rodrigues(T_w2c_PB(1:3, 1:3));
wx=w(1);
wy=w(2);
wz=w(3);

x0 =[T_w2c_PB(1,4), T_w2c_PB(2,4), T_w2c_PB(3,4)];

<span class="comment">% optimization using fmincon</span>

options = optimoptions(<span class="string">'fmincon'</span>, <span class="string">'Display'</span>,<span class="string">'iter'</span>, <span class="string">'Algorithm'</span>, <span class="string">'interior-point'</span>);

[x, fval, exittag] = fmincon(@simulation_wldpose,x0,[],[],[],[],[],[],[], options, wld_pose, cam_pose, T_w2c_PB);

<span class="comment">% get refined extrinsics</span>
t_est = x(1:3)';

T_w2c_WK = [T_w2c_PB(1:3, 1:3), t_est ; 0 0 0 1];
</pre><pre class="codeoutput">                                            First-order      Norm of
 Iter F-count            f(x)  Feasibility   optimality         step
    0       4    4.660679e+01    0.000e+00    5.100e+02
    1      29    4.660267e+01    0.000e+00    3.203e+03    1.321e-05
    2      34    4.658371e+01    0.000e+00    2.601e+03    2.643e-05
    3      38    3.434641e+01    0.000e+00    5.000e+03    1.766e-02
    4      42    2.947761e+01    0.000e+00    5.000e+03    8.761e-02
    5      46    2.001865e+01    0.000e+00    5.000e+03    4.475e-02
    6      55    1.358230e+01    0.000e+00    5.000e+03    4.475e-02
    7      63    5.695186e+00    0.000e+00    5.000e+03    2.247e-02
    8      75    4.455391e+00    0.000e+00    5.000e+03    9.833e-03
    9      84    3.186934e+00    0.000e+00    5.000e+03    4.916e-03
   10      91    2.363801e+00    0.000e+00    5.000e+03    2.458e-03
   11      95    1.648258e+00    0.000e+00    5.000e+03    2.120e-03
   12     102    1.502347e+00    0.000e+00    5.000e+03    6.029e-04
   13     106    1.231465e+00    0.000e+00    5.000e+03    6.276e-04
   14     112    1.180853e+00    0.000e+00    5.000e+03    4.156e-04
   15     116    1.063171e+00    0.000e+00    5.000e+03    2.582e-04
   16     121    1.045399e+00    0.000e+00    5.000e+03    9.581e-05
   17     125    1.040267e+00    0.000e+00    5.000e+03    1.453e-04
   18     129    1.026250e+00    0.000e+00    5.000e+03    6.322e-05
   19     134    1.017018e+00    0.000e+00    5.000e+03    8.532e-05
   20     138    9.815636e-01    0.000e+00    5.000e+03    4.374e-05
   21     143    9.811007e-01    0.000e+00    5.000e+03    4.570e-05
   22     147    9.565868e-01    0.000e+00    5.000e+03    1.742e-05
   23     151    9.177253e-01    0.000e+00    5.000e+03    8.708e-05
   24     155    8.433547e-01    0.000e+00    5.000e+03    3.233e-05
   25     162    7.891360e-01    0.000e+00    5.039e+02    2.744e-05
   26     166    7.777500e-01    0.000e+00    3.200e+03    3.266e-05
   27     170    7.745900e-01    0.000e+00    4.200e+03    1.503e-04
   28     174    7.366179e-01    0.000e+00    1.000e+03    7.801e-05
   29     179    7.328213e-01    0.000e+00    1.000e+03    1.894e-05
   30     183    7.318283e-01    0.000e+00    1.639e+02    8.323e-06

                                            First-order      Norm of
 Iter F-count            f(x)  Feasibility   optimality         step
   31     187    7.315495e-01    0.000e+00    4.000e+02    2.424e-06
   32     192    7.315361e-01    0.000e+00    2.000e+02    1.136e-06
   33     196    7.315290e-01    0.000e+00    1.614e+01    3.443e-07
   34     201    7.315285e-01    0.000e+00    7.105e+00    2.648e-07
   35     208    7.315284e-01    0.000e+00    9.225e+00    1.726e-08
   36     212    7.315282e-01    0.000e+00    3.961e+00    5.145e-08
   37     217    7.315278e-01    0.000e+00    1.614e+01    1.774e-07
   38     224    7.315277e-01    0.000e+00    1.078e+01    1.786e-08
   39     228    7.315276e-01    0.000e+00    3.116e+00    8.988e-09
   40     232    7.315276e-01    0.000e+00    1.807e+00    3.828e-09

Local minimum possible. Constraints satisfied.

fmincon stopped because the size of the current step is less than
the default value of the step size tolerance and constraints are 
satisfied to within the default value of the constraint tolerance.



</pre><h2>Results<a name="5"></a></h2><pre class="codeinput"><span class="comment">% matrices</span>

T_w2c_init

T_w2c_init_n

T_w2c_PB

T_w2c_WK

<span class="comment">% world poses</span>

wld_pose;

t_w_init_n = T_w2c_init_n *cam_pose;

t_w_PB = T_w2c_PB*cam_pose;

t_w_WK = T_w2c_WK*cam_pose;


<span class="comment">% error of projection</span>

[mean_abs_error_init_n, std_deviation_init_n,  mean_error_3D_init_n, std_deviation_3D_init_n]  = translationErrorBetweenPointsInWorld(wld_pose, t_w_PB)

[mean_abs_error_pb, std_deviation_pb,  mean_error_3D_pb, std_deviation_3D_pb]  = translationErrorBetweenPointsInWorld(wld_pose, t_w_PB)

[mean_abs_error_wk, std_deviation_wk,  mean_error_3D_wk, std_deviation_3D_wk]  = translationErrorBetweenPointsInWorld(wld_pose, t_w_WK)
</pre><pre class="codeoutput">
T_w2c_init =

    0.9754    0.2206         0   -0.0470
   -0.2206    0.9754         0    0.0500
         0         0    1.0000   -0.0900
         0         0         0    1.0000


T_w2c_init_n =

    0.9482    0.0918   -0.3041   -0.1740
   -0.0183    0.9715    0.2362    0.1585
    0.3172   -0.2184    0.9229   -0.1956
         0         0         0    1.0000


T_w2c_PB =

    0.9754    0.2206    0.0000   -0.0745
   -0.2206    0.9754   -0.0000   -0.0157
   -0.0000    0.0000    1.0000   -0.0900
         0         0         0    1.0000


T_w2c_WK =

    0.9754    0.2206    0.0000   -0.0470
   -0.2206    0.9754   -0.0000    0.0500
   -0.0000    0.0000    1.0000   -0.0900
         0         0         0    1.0000


mean_abs_error_init_n =

    0.0275
    0.0657
    0.0000
         0


std_deviation_init_n =

    0.0278
    0.0664
    0.0000
         0


mean_error_3D_init_n =

    0.0712


std_deviation_3D_init_n =

   5.7129e-06


mean_abs_error_pb =

    0.0275
    0.0657
    0.0000
         0


std_deviation_pb =

    0.0278
    0.0664
    0.0000
         0


mean_error_3D_pb =

    0.0712


std_deviation_3D_pb =

   5.7129e-06


mean_abs_error_wk =

   1.0e-05 *

    0.4013
    0.5148
    0.2962
         0


std_deviation_wk =

   1.0e-05 *

    0.4909
    0.6102
    0.3658
         0


mean_error_3D_wk =

   7.9330e-06


std_deviation_3D_wk =

   3.2391e-06

</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2015a</a><br></p></div><!--
##### SOURCE BEGIN #####
clear
clc

path = '/home/cat/Documents/CMU_Herb/camera_ext_calibration/';
path = '~/cat_workspace/src/ExtrinsicsCalibration/matlab_code/';
addpath([path, 'ADAcode'])

% (1) Create world data from a table randomly 

n = 100;
tb_height = 0.5;

min_x = 0.5; max_x = 1;
min_y = -0.3; max_y = 0.3;
x = min_x + (max_x-min_x).*rand(n,1); 
y = min_y + (max_y-min_y).*rand(n,1); 
z = ones(n,1).* tb_height;
tag_xyz = [x y z ones(n, 1)];

for i=1:n
    tag_euler = [0 0 0.0001];
    tag_rotation = rotationAroundZ(tag_euler(3))* rotationAroundY(tag_euler(2))* rotationAroundX(tag_euler(1));
    T_w2tag(:, :, i) = [tag_rotation tag_xyz(i, 1:3)'; 0 0 0 1];
end

tag_size = 0.06;
ts = tag_size/2;
for i=1:n
    t = T_w2tag(:, :, i);
    c1 = t; c1(1,4) = t(1,4)+ts; c1(2,4) = t(2,4)+ts; 
    c2 = t; c2(1,4) = t(1,4)-ts; c2(2,4) = t(2,4)+ts;
    c3 = t; c3(1,4) = t(1,4)-ts; c3(2,4) = t(2,4)-ts;
    c4 = t; c4(1,4) = t(1,4)+ts; c4(2,4) = t(2,4)-ts;
    
    T_w2tag_c1(:, :, i) = c1; 
    T_w2tag_c2(:, :, i) = c2;
    T_w2tag_c3(:, :, i) = c3;
    T_w2tag_c4(:, :, i) = c4;
end



%% (2) Create a T_wc matrix

T_w2c_init = [0.9754 0.2206 0 -0.0470; ...
         -0.2206 0.9754 0 0.05; ...
         0 0 1 -0.09; ...
         0 0 0 1];

% using T_w2c (perfect matrix)
tagposes = T_w2tag;
for n =1:size(T_w2tag,3)
   % passing T_c_tag
   T_c_tag(:, :, n) = inv(T_w2c_init) * tagposes(:, :, n);
   T_c_c1(:, :, n) = inv(T_w2c_init) * T_w2tag_c1(:, :, n);
   T_c_c2(:, :, n) = inv(T_w2c_init) * T_w2tag_c2(:, :, n);
   T_c_c3(:, :, n) = inv(T_w2c_init) * T_w2tag_c3(:, :, n);
   T_c_c4(:, :, n) = inv(T_w2c_init) * T_w2tag_c4(:, :, n);
end

A = [529.2945         0  466.9604         0; ...
            0  531.2835  273.2594         0; ...
            0         0    1.0000         0; ...
            0         0         0    1.0000];

c1 = []; c2 = []; c3 = []; c4 = [];
for n =1:size(T_w2tag,3)
   tc_1 = T_c_c1(:, :, n) ;
   corner1 = A * tc_1(1:4, 4);
   c1(n, :) = [corner1(1)/corner1(3) corner1(2)/corner1(3) 1];

   tc_2 = T_c_c2(:, :, n) ;
   corner2 = A * tc_2(1:4, 4);
   c2(n, :) = [corner2(1)/corner2(3) corner2(2)/corner2(3) 1];
   
   tc_3 = T_c_c3(:, :, n) ;
   corner3 = A * tc_3(1:4, 4);
   c3(n, :) = [corner3(1)/corner3(3) corner3(2)/corner3(3) 1];
   
   tc_4 = T_c_c4(:, :, n) ;
   corner4 = A * tc_4(1:4, 4);
   c4(n, :) = [corner4(1)/corner4(3) corner4(2)/corner4(3) 1];
end


% (3) Add Gaussian noise (statistically independent and addictive noise) to
% data

ratio = 0.3;
a = rodrigues(T_w2c_init(1:3, 1:3));
N = randn(size(a));
N = N*ratio;
a = a + N;
R = rodrigues(a);
t = T_w2c_init(1:3, 4);N = randn(size(t));N = N*ratio;
t = t + N;
T_w2c_init_n = [R t; 0 0 0 1];

counter = 0;
for i=1:size(T_c_tag,3) 
        
    t_c = T_c_tag(:, :, i)
    t_w = T_w2c_init_n * t_c
  
    zhat_tag = t_w(1:3, 3);
    z_tag =  t_w(3, 4);
    counter = counter + 1;
    norm_z(counter) = norm(z_tag - 0.5);
    
    CosTheta = dot(zhat_tag, [0 0 1]')/(norm(zhat_tag)*norm([0 0 1]'));
    theta_error(counter) = acos(CosTheta);
       
end

wld_points_train = T_w2tag(:, :, 1:n/2);
wld_points_test = T_w2tag(:, :, n/2+1:end);
cam_points_train = T_c_tag(:, :, 1:n/2);
cam_points_test = T_c_tag(:, :, n/2+1:end);
corners_train.c1 = c1(1:n/2, :);
corners_train.c2 = c2(1:n/2, :);
corners_train.c3 = c3(1:n/2, :);
corners_train.c4 = c4(1:n/2, :);
corners_test.c1 = c1(n/2+1:end, :);
corners_test.c2 = c2(n/2+1:end, :);
corners_test.c3 = c3(n/2+1:end, :);
corners_test.c4 = c4(n/2+1:end, :);

%% (4)run PB function

%  find x
w=rodrigues(T_w2c_init_n(1:3, 1:3))
wx=w(1);
wy=w(2);
wz=w(3);

x0 =[wx, wy, wz, T_w2c_init_n(1,4), T_w2c_init_n(2,4), T_w2c_init_n(3,4)]

% optimization using fmincon
options = optimoptions('fmincon', 'Display','iter', 'Algorithm', 'interior-point');
[x, fval, exittag] = fmincon(@simulation_minimizeExtrinsics,x0,[],[],[],[],[],[],[], options, cam_points_train, corners_train, x0);

% get refined extrinsics
[R_est, t_est] = xToRt(x(1:6));

T_w2c_PB = [R_est, t_est ; 0 0 0 1];

%% Run World Known Poses Based Optimization (with test data)

counter = 0;
for i=n/2+1:size(T_c_tag,3)
    counter = counter + 1;
    cam_pose(:, counter) = [T_c_tag(:, 4, i)];
    wld_pose(:, counter) = [T_w2tag(:, 4, i)];
end
     
w=rodrigues(T_w2c_PB(1:3, 1:3));
wx=w(1);
wy=w(2);
wz=w(3);

x0 =[T_w2c_PB(1,4), T_w2c_PB(2,4), T_w2c_PB(3,4)];

% optimization using fmincon

options = optimoptions('fmincon', 'Display','iter', 'Algorithm', 'interior-point');

[x, fval, exittag] = fmincon(@simulation_wldpose,x0,[],[],[],[],[],[],[], options, wld_pose, cam_pose, T_w2c_PB);

% get refined extrinsics
t_est = x(1:3)';

T_w2c_WK = [T_w2c_PB(1:3, 1:3), t_est ; 0 0 0 1];

%% Results

% matrices 

T_w2c_init

T_w2c_init_n

T_w2c_PB

T_w2c_WK

% world poses

wld_pose;

t_w_init_n = T_w2c_init_n *cam_pose;

t_w_PB = T_w2c_PB*cam_pose;

t_w_WK = T_w2c_WK*cam_pose;


% error of projection 

[mean_abs_error_init_n, std_deviation_init_n,  mean_error_3D_init_n, std_deviation_3D_init_n]  = translationErrorBetweenPointsInWorld(wld_pose, t_w_PB)

[mean_abs_error_pb, std_deviation_pb,  mean_error_3D_pb, std_deviation_3D_pb]  = translationErrorBetweenPointsInWorld(wld_pose, t_w_PB)

[mean_abs_error_wk, std_deviation_wk,  mean_error_3D_wk, std_deviation_3D_wk]  = translationErrorBetweenPointsInWorld(wld_pose, t_w_WK)


##### SOURCE END #####
--></body></html>